
# Makefile to install foomatic-filters
# $Revision$

# PREFIX defaults to /usr/local for manually installed progs, so that they
# are not messed up on a system upgrade.
#
# `architecture independent', static data files i.e. perl libs go into
#   $(PREFIX)/share/foomatic
# (user) executables into $(PREFIX)/bin/
# system binaries go into $(PREFIX)/sbin
# configuration files into /etc/foomatic/*.
#

# Variables

DEBUG=

prefix=@prefix@
exec_prefix=@exec_prefix@
libdir=@libdir@
bindir=@bindir@
sbindir=@sbindir@
mandir=@mandir@
sysconfdir=@sysconfdir@

PREFIX=$(prefix)

BINDIR=$(bindir)
SBINDIR=$(sbindir)
MANDIR=$(mandir)
ETCDIR=$(sysconfdir)/foomatic

# Paths for CUPS
CUPS_FILTERS=@CUPS_FILTERS@

# Paths for PPR
PPR_INTERFACES=@PPR_INTERFACES@

# Genereal paths for all filter scripts
EXEC_PATH=/usr/local/bin:/usr/bin:/bin
LOG_PATH=/tmp

# This is mainly useful for building a binary foomatic package
DESTDIR=/

### Probably nothing to fiddle past here

# Files generated by the AC_OUTPUT call of "./configure"
AC_OUTPUT_FILES:=Makefile makeMan foomatic-gswrapper \
	src/cupsomatic.pl src/directomatic.pl \
	src/lpdomatic.pl src/ppromatic.pl

# User programs and helper programs
BINFILES:=foomatic-gswrapper directomatic

# Filters, only useful for admins
SBINFILES:=lpdomatic

# Masks for trash files which have to be removed before packaging Foomatic
TRASHFILES:="*~" "*\#*" ".??*" "*.rej"

all: build

# The install rule should check for kitloads and avoid stomping.  It doesn't
install: install-bin install-man

check-config:
	@if [ -f .testing-stamp ] ; then \
	  echo 'Cowardly refusing to install inplace-built filters.' ;\
	  echo 'Use "make testing_clean; make" to get proper ones.' ;\
	  exit 1 ;\
	fi

install-bin: check-config
	install -d $(DESTDIR)$(BINDIR)
	install -d $(DESTDIR)$(SBINDIR)
	install -d $(DESTDIR)$(ETCDIR)
	install -d $(DESTDIR)$(ETCDIR)/direct
	install -d $(DESTDIR)$(CUPS_FILTERS)
	install -d $(DESTDIR)$(PPR_INTERFACES)
	cp -f $(BINFILES) $(DESTDIR)$(BINDIR)
	cp -f $(SBINFILES) $(DESTDIR)$(SBINDIR)
	cp -f cupsomatic $(DESTDIR)$(CUPS_FILTERS)
	cp -f ppromatic $(DESTDIR)$(PPR_INTERFACES)
	cp -f filter.conf $(DESTDIR)$(ETCDIR)

install-man: check-config
	install -d $(DESTDIR)$(MANDIR)
	install -d $(DESTDIR)$(MANDIR)/man1
	install -d $(DESTDIR)$(MANDIR)/man8
	cp -f *.1 $(DESTDIR)$(MANDIR)/man1
	cp -f *.8 $(DESTDIR)$(MANDIR)/man8

build:  scripts man

man:
	chmod a+rx ./makeMan
	if [ "$(INPLACE)" == "--inplace" ]; then \
	  export LPDOMATIC=`pwd`/lpdomatic; \
	  export FOO_ETC=`pwd`/etc/foomatic; \
	  export PRINTCAP=@PRINTCAP@; \
	else \
	  export LPDOMATIC=$(SBINDIR)/lpdomatic; \
	  export FOO_ETC=$(ETCDIR); \
	  export PRINTCAP=@PRINTCAP@; \
	fi; \
	./makeMan

clean: remove-trash
	$(MAKE) -C src clean
	rm -f *~ .testing-stamp
	rm -f *.o
	$(RM) $(BINFILES:=.1) $(SBINFILES:=.8)

distclean: clean
	rm -f $(AC_OUTPUT_FILES) config.log config.status config.cache
	rm -rf autom*.cache confdefs.h

maintainer-clean: distclean
	rm -f configure aclocal.m4

# Uninstall an installed Foomatic
uninstall: uninstall-bin uninstall-man

uninstall-bin: check-config
	( cd $(DESTDIR)$(BINDIR) && \
	  rm -f $(BINFILES) \
	)
	( cd $(DESTDIR)$(SBINDIR) && \
	  rm -f $(SBINFILES) \
	)
	rm -f $(DESTDIR)$(CUPS_FILTERS)/cupsomatic
	rm -f $(DESTDIR)$(PPR_INTERFACES)/ppromatic
	rm -f $(DESTDIR)$(ETCDIR)/filter.conf
	rmdir $(DESTDIR)$(ETCDIR)/direct || :
	rmdir $(DESTDIR)$(ETCDIR) || :

uninstall-man: check-config
	for m in $(BINFILES); do \
	  rm -f $(DESTDIR)$(MANDIR)/man1/$$m.*; \
	done
	for m in $(SBINFILES); do \
	  rm -f $(DESTDIR)$(MANDIR)/man8/$$m.*; \
	done

# Various testing/debugging/etc targets
inplace: testing
testing: INPLACE = --inplace
testing: build

inplace-clean: testing_clean
testing-clean: clean

# Remove editor backup and temporary files
remove-trash:
	for m in $(TRASHFILES); do \
	  find . -name "$$m" -exec rm "{}" \; ; \
	done

# We need to export all Variables for makeDefaults and the scripts target to
# work.
.EXPORT_ALL_VARIABLES:

scripts: $(AC_OUTPUT_FILES)
	$(MAKE) -C src scripts
	chmod a+rx $(AC_OUTPUT_FILES)

# Use INPLACE=--inplace to get the special run-in-place Defaults.

.PHONY: all check-config build install install-bin \
	man inplace testing clean inplace-clean testing-clean distclean \
	maintainer-clean
